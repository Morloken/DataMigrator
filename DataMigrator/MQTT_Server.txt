using System;
using System.Globalization;
using System.IO;
using Microsoft.Extensions.Configuration;
using Npgsql;

class Program
{
    static void Main()
    {
        var builder = new ConfigurationBuilder()
            .SetBasePath(AppContext.BaseDirectory)
            .AddJsonFile("C:\\Users\\user1\\Documents\\GitHub\\DataMigrator\\DataMigrator\\appsettings.json", optional: false, reloadOnChange: true);

        var configuration = builder.Build();
        string targetConnStr = configuration.GetConnectionString("AtmosphereDB");

        Console.WriteLine("Підключення до БД: " + targetConnStr);

        string csvFile = Path.Combine(AppContext.BaseDirectory, "C:\\Users\\user1\\Documents\\Tables\\MQTT_Server.csv");

        InsertMqttServers(csvFile, targetConnStr);

        Console.WriteLine("Міграція MQTT_Server завершена потужно!");
    }

    static void InsertMqttServers(string csvPath, string connStr)
    {
        if (!File.Exists(csvPath))
        {
            Console.WriteLine("CSV файл не знайдено: " + csvPath);
            return;
        }

        var lines = File.ReadAllLines(csvPath);
        if (lines.Length < 2)
        {
            Console.WriteLine("CSV порожній або тільки заголовок.");
            return;
        }

        using var conn = new NpgsqlConnection(connStr);
        conn.Open();

        for (int i = 1; i < lines.Length; i++)
        {
            var values = lines[i].Split(',');
            if (values.Length < 3)
            {
                Console.WriteLine($"Пропускаємо рядок {i} – недостатньо колонок.");
                continue;
            }

            string url = values[0].Trim();
            string statusText = values[1].Trim().ToLower();
            bool status = statusText == "enabled" || statusText == "true";
            Guid idServer = Guid.NewGuid();

            string insertQuery = "INSERT INTO mqtt_server (id_server, url, status) VALUES (@id, @url, @status)";
            using var insertCmd = new NpgsqlCommand(insertQuery, conn);
            insertCmd.Parameters.AddWithValue("id", idServer);
            insertCmd.Parameters.AddWithValue("url", url);
            insertCmd.Parameters.AddWithValue("status", status);

            insertCmd.ExecuteNonQuery();

            Console.WriteLine($"Додано: {url} (Status: {status})");
        }

        conn.Close();
    }
}
